(()=>{"use strict";var t={d:(e,i)=>{for(var s in i)t.o(i,s)&&!t.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:i[s]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{clock_res_get:()=>o,clock_time_get:()=>h,fd_write:()=>l});var i={};t.r(i),t.d(i,{lu5_GetKeyName:()=>B,lu5_background:()=>H,lu5_createWindow:()=>L,lu5_getCursorPos:()=>I,lu5_glBegin:()=>b,lu5_glEnd:()=>T,lu5_glVertex2:()=>k,lu5_load_and_add_font:()=>P,lu5_load_image:()=>A,lu5_loop:()=>K,lu5_noLoop:()=>F,lu5_open_file:()=>C,lu5_read_file:()=>U,lu5_render_arc_fill:()=>m,lu5_render_arc_stroke:()=>w,lu5_render_ellipse:()=>f,lu5_render_ellipse_w_stroke:()=>_,lu5_render_image:()=>M,lu5_render_line:()=>d,lu5_render_quad:()=>u,lu5_render_quad_fill:()=>x,lu5_render_quad_stroke:()=>p,lu5_render_text:()=>g,lu5_render_triangle_fill:()=>y,lu5_set_font:()=>E,lu5_time_seed:()=>j,lu5_write_file:()=>W});const s=["lu5_image_crop","lu5_render_debug","lu5_render_box_faces","lu5_render_box_edges","lu5_render_cylinder_faces","lu5_render_cylinder_edges","lu5_render_torus_faces","lu5_render_torus_edges","lu5_render_plane_faces","lu5_render_plane_edges","lu5_render_ellipsoid_faces","lu5_render_ellipsoid_edges","lu5_swapBuffers","lu5_pollEvents","lu5_setWindowShouldClose","lu5_PushMatrix","lu5_PopMatrix","lu5_glVertex2","lu5_init_freetype","lu5_close_fonts","lu5_load_default_font"],n=["random_get","args_get","args_sizes_get","environ_get","environ_sizes_get","fd_close","fd_prestat_get","fd_prestat_dir_name","fd_read","fd_seek","proc_exit","path_open","path_unlink_file","path_filestat_get","path_filestat_set_times","path_symlink","path_link","path_remove_directory","poll_oneoff","proc_raise","sched_yield","sock_send","sock_recv","sock_shutdown","sock_close","fd_fdstat_get","fd_fdstat_set_flags","fd_sync","fd_allocate","fd_advise","path_rename","path_open","fd_filestat_get","fd_filestat_set_times","fd_filestat_set_size","fd_filestat_set_times","fd_renumber","fd_datasync","fd_pread","fd_pwrite","fd_readdir","fd_fdstat_set_rights","fd_tell","path_create_directory","path_readlink","path_filestat_set_size","sock_accept","sock_bind","sock_connect","sock_listen","sock_recvmsg","sock_sendmsg","sock_create","sock_shutdown","sock_recv","sock_send"];let r="";function l(t,e,i,s){if(!this.memory)return;this.refreshMemory();const n=this.memory.buffer;let l=0;const o=[];for(let t=0;t<i;t++){const i=e+8*t;if(i<0||i+8>n.byteLength){this.error(`fd_write: iovec_ptr (${i}) out of bounds at iovec index ${t}`);continue}const s=this.view.getUint32(i,!0),r=this.view.getUint32(i+4,!0);if(s<0||s+r>n.byteLength){this.error(`fd_write: Data pointer (${s}) out of bounds or invalid size at iovec index ${t}`);continue}if(r<=0)continue;const h=new Uint8Array(this.memory.buffer,s,r);o.push(h),l+=r}let h=new Uint8Array(l),a=0;o.forEach((t=>{h.set(t,a),a+=t.length}));let c=(new TextDecoder).decode(h);switch(t){case 1:this.log(c);break;case 2:r+=c,c.includes("\n")&&(this.error(r),r="");break;default:return this.error("fd_write: unknown file descriptor"),1}let u=l;return this.view&&this.view.setUint32(s,u,!0),0}function o(t,e){return this.view&&this.view.setBigUint64(e,1000n,!0),0}function h(t,e,i){return this.view&&this.view.setBigUint64(i,1000000n*BigInt(Date.now()),!0),0}function a(t,e,i){if(!t)return"";if(void 0!==i){let s=new Uint8Array(t.buffer,e,i);return(new TextDecoder).decode(s)}let s=new Uint8Array(t.buffer,e,t.buffer.byteLength-e);return(new TextDecoder).decode(s.subarray(0,s.indexOf(0)))}function c(t,e,i){if(!t)return;let s=(new TextEncoder).encode(i),n=new Uint8Array(s.length+1);n.set(s),n[s.length]=0;let r=new Uint8Array(t.buffer);e+n.length>=t.buffer.byteLength?this.error("write_cstr Memory overflow"):r.set(n,e)}function u(t,e,i,s,n,r,l,o,h,a,c){this.ctx&&(this.ctx.fillStyle=this.colorToHex(a),this.ctx.strokeStyle=this.colorToHex(c),this.ctx.lineWidth=h,this.ctx.beginPath(),this.ctx.moveTo(t,e),this.ctx.lineTo(i,s),this.ctx.lineTo(n,r),this.ctx.lineTo(l,o),this.ctx.closePath(),this.ctx.stroke(),this.ctx.fill())}function d(t,e,i,s,n,r){this.ctx&&(this.ctx.lineWidth=2*n,this.ctx.lineCap="round",this.ctx.strokeStyle=this.colorToHex(r),this.ctx.beginPath(),this.ctx.moveTo(t,e),this.ctx.lineTo(i,s),this.ctx.stroke())}function _(t,e,i,s,n,r,l,o){this.ctx&&(this.ctx.fillStyle=this.colorToHex(r),this.ctx.strokeStyle=this.colorToHex(l),this.ctx.beginPath(),this.ctx.ellipse(t,e,s,i,0,0,2*Math.PI),this.ctx.lineWidth=n,this.ctx.stroke(),this.ctx.fill())}function f(t,e,i,s,n,r){this.ctx&&(this.ctx.fillStyle=this.colorToHex(n),this.ctx.beginPath(),this.ctx.ellipse(t,e,i,s,0,0,2*Math.PI),this.ctx.fill())}function m(t,e,i,s,n,r,l,o){this.ctx&&(this.ctx.fillStyle=this.colorToHex(o),this.ctx.beginPath(),this.ctx.ellipse(t,e,i,s,0,n,r),this.ctx.lineTo(t,e),this.ctx.closePath(),this.ctx.fill())}function w(t,e,i,s,n,r,l,o,h){this.ctx&&(this.ctx.strokeStyle=this.colorToHex(h),this.ctx.beginPath(),this.ctx.ellipse(t,e,i,s,0,r,l),this.ctx.lineWidth=n,this.ctx.stroke())}function x(t,e,i,s,n,r,l,o,h){this.ctx&&(this.ctx.fillStyle=this.colorToHex(h),this.ctx.beginPath(),this.ctx.moveTo(t,e),this.ctx.lineTo(i,s),this.ctx.lineTo(n,r),this.ctx.lineTo(l,o),this.ctx.closePath(),this.ctx.fill())}function p(t,e,i,s,n,r,l,o,h,a){if(!this.ctx)return;this.ctx.strokeStyle=this.colorToHex(a);const c=Math.min(t,i,n,l),u=Math.min(e,s,r,o),d=Math.max(t,i,n,l)-c,_=Math.max(e,s,r,o)-u;this.ctx.lineWidth=h,this.ctx.strokeRect(c,u,d,_)}function g(t,e,i,s,n,r,l){if(!this.ctx)return;const o=a(this.memory,t);switch(n){case 1:this.ctx.textAlign="center";break;case 2:this.ctx.textAlign="right";break;case 3:this.ctx.textAlign="left"}this.ctx.font=`${s}px ${this.ctx.font.split(" ")[1]}`,this.ctx.fillStyle=this.colorToHex(l),this.ctx.fillText(o,e,i-4)}function y(t,e,i,s,n,r,l){if(this.ctx)return this.ctx.beginPath(),this.ctx.fillStyle=this.colorToHex(l),this.ctx.moveTo(t,e),this.ctx.lineTo(i,s),this.ctx.lineTo(n,r),this.ctx.closePath(),this.ctx.fill(),this.ctx.stroke(),0}let v=!0;function b(t,e){this.ctx&&(this.ctx.fillStyle=this.colorToHex(e),this.ctx.beginPath())}function k(t,e){this.ctx&&(v?(this.ctx.moveTo(t,e),v=!1):this.ctx.lineTo(t,e))}function T(){this.ctx&&(this.ctx.closePath(),v=!0,this.ctx.fill(),this.ctx.stroke())}let S=[];function A(t,e){const i=a(this.memory,e),s=new Image;s.src=i,S.push(s),this.refreshMemory();const n=this.calls.malloc(12);return this.view.setUint32(n,S.length-1),this.view.setInt32(n+1,s.width),this.view.setInt32(n+2,s.height),n}function M(t,e,i,s,n,r,l){const o=this.view.getUint32(e),h=S[o];h.complete&&(this.ctx.globalAlpha=this.colorToRGBA(l)[3]/255,this.ctx.drawImage(h,i,s,n,r),this.ctx.globalAlpha=1)}function P(t,e){return this.warn("Calling [90m'loadFont'[0m on the Web is ignored. Instead, use textFont directly."),1}function E(t){const e=a(this.memory,t);return this.ctx.font=`${this.ctx.font.split(" ")[0]} ${e}`,0}async function C(t,e){return this.warn("File I/O is not supported in lu5-wasm yet"),0}async function U(t,e,i){return this.warn("File I/O is not supported in lu5-wasm yet"),0}function W(){return this.warn("File I/O is not supported in lu5-wasm yet"),0}function O(t,e,i=document.body){let s=document.getElementById(e);return null===s&&(s=document.createElement(t),s.setAttribute("id",e),i?i.appendChild(s):window.onload=()=>i.appendChild(s)),s}function L(t,e,i,s,n){if(!this.wasm)return 0;if(this.depth_mode=n,1==n)return this.warn("3D Mode is not yet supported in lu5-wasm."),this.loop=!1,0;const r=O("canvas",this.canvas_id);switch(r.style.display="inline",r.width=e,r.height=i,n){case 0:this.ctx=r.getContext("2d");break;case 1:this.gl=r.getContext("webgl")}return this.events.handleWheel=this.handleWheel.bind(this),document.addEventListener("wheel",this.events.handleWheel),this.events.handleKeydown=this.handleKeydown.bind(this),document.addEventListener("keydown",this.events.handleKeydown),this.events.handleKeyup=this.handleKeyup.bind(this),document.addEventListener("keyup",this.events.handleKeyup),r.addEventListener("mousemove",this.handleMousemove.bind(this)),r.addEventListener("mousedown",this.handleMousedown.bind(this)),r.addEventListener("mouseup",this.handleMouseup.bind(this)),0}function H(t){switch(this.depth_mode){case 0:if(!this.ctx)break;this.ctx.fillStyle=this.colorToHex(t),this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.ctx.fill();break;case 1:if(!this.gl)break;this.gl.clearColor(0,0,0,1),this.gl.clear(this.gl.COLOR_BUFFER_BIT)}}function I(t,e,i){return this.refreshMemory(),this.view&&(this.view.setFloat64(e,this.mouseX,!0),this.view.setFloat64(i,this.mouseY,!0)),0}function F(){this.loop=!1}function K(){this.loop||requestAnimationFrame(this.frame),this.loop=!0}function j(){return Math.floor(1e6*Math.random())}function B(t,e){null==this.keyname_ptr&&this.calls.free(this.keyname_ptr);let i=null;return t>=65&&t<=90&&(i=String.fromCharCode(t)),t>=48&&t<=57&&(i=String.fromCharCode(t)),t>=320&&t<=329&&(i="Numpad "+(t-320)),t>=290&&t<=299&&(i="F"+(t-290+1)),null===i?(this.keyname_ptr=null,this.keyname_ptr):(this.keyname_ptr=this.calls.malloc(i.length),c(this.memory,this.keyname_ptr,i),this.keyname_ptr)}function R(t){if(this.refreshMemory(),!this.view)return"#00000000";const e=this.view.getUint8(t);if(0==e)return"#00000000";return"#"+this.view.getUint8(t+3).toString(16).padStart(2,"0")+this.view.getUint8(t+2).toString(16).padStart(2,"0")+this.view.getUint8(t+1).toString(16).padStart(2,"0")+e.toString(16).padStart(2,"0")}function $(t){if(this.refreshMemory(),!this.view)return[0,0,0,0];const e=this.view.getUint8(t);return 0==e?[0,0,0,0]:[this.view.getUint8(t+3),this.view.getUint8(t+2),this.view.getUint8(t+1),e]}const q=t=>+t.metaKey<<8|+t.ctrlKey<<2,D={0:0,8:259,9:258,13:257,16:340,17:341,18:342,19:284,20:280,27:256,32:32,33:266,34:267,35:269,36:268,37:263,38:265,39:262,40:264,45:260,46:261,48:48,49:49,50:50,51:51,52:52,53:53,54:54,55:55,56:56,57:57,65:65,66:66,67:67,68:68,69:69,70:70,71:71,72:72,73:73,74:74,75:75,76:76,77:77,78:78,79:79,80:80,81:81,82:82,83:83,84:84,85:85,86:86,87:87,88:88,89:89,90:90,91:343,92:344,93:348,96:320,97:321,98:322,99:323,100:324,101:325,102:326,103:327,104:328,105:329,106:332,107:334,109:333,110:330,111:331,112:290,113:291,114:292,115:293,116:294,117:295,118:296,119:297,120:298,121:299,122:300,123:301,144:282,145:281,186:59,187:61,188:44,189:45,190:46,191:47,192:96,219:91,220:92,221:93,222:39};var N,X,Y=function(t,e,i,s){if("a"===i&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!s:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?s:"a"===i?s.call(t):s?s.value:e.get(t)};class z{constructor(){N.add(this),this.colorToHex=R.bind(this),this.colorToRGBA=$.bind(this),this.wasm,this.canvas_id="lu5-canvas",this.fd=[],this.l5=null,this.ctx=null,this.gl=null,this.memory=null,this.view=null,this.lastTime=0,this.mouseX=0,this.mouseY=0,this.loop=!0,this.frame=void 0,this.debug_tag=void 0,this.depth_mode=0,this.events={}}write(t,e,i){const s=this.fd[t];s&&s.forEach((t=>{t[e]&&t[e](i)}))}error(t){(t=t.replace(/\[string ".*?"\]:(\d+):/g,((t,e)=>`line ${e}: `))).includes(z.err_prefix)||(t=`${z.err_prefix} ${t}`),this.write(2,"error",t)}log(t){this.write(1,"log",t)}warn(t){this.write(1,"warn",t)}clear(){return this.fd.forEach((t=>t?t.forEach((t=>t.clear())):0)),this}handle_exception(t){if(t instanceof WebAssembly.RuntimeError?t.message.includes("unreachable")||(this.log(t.message),this.log(t.stack)):t instanceof WebAssembly.Exception?t.is(this.debug_tag)?this.error(t.getArg(this.debug_tag,0)):this.error("Unknown exception"):this.error(t.toString()),this.loop=!1,this.l5&&(this.calls._lu5_close(this.l5),document.removeEventListener("wheel",this.events.handleWheel),document.removeEventListener("keydown",this.events.handleKeydown),document.removeEventListener("keyup",this.events.handleKeyup),this.ctx&&this.ctx.canvas.parentNode)){let t=this.ctx.canvas.cloneNode(!0);this.ctx.canvas.parentNode.replaceChild(t,this.ctx.canvas)}}static wrap_calls(t){const e={};for(const[i,s]of Object.entries(t.wasm.exports))e[i]=function(){try{return s(...arguments)}catch(e){t.handle_exception(e)}};return e}refreshMemory(){this.memory&&(null!==this.view&&0!==this.view.buffer.byteLength||(this.view=new DataView(this.memory.buffer)))}static makeEnv(t,e,i){const s={},n=[...new Set([...e,...Object.keys(i)])];for(let e of n)s[e]=null==i[e]?()=>0:i[e].bind(t);return s}static async compile(t){const e=await fetch(t),i=await e.arrayBuffer();return await WebAssembly.compile(i)}static async instantiate(t){const r=new z;r.debug_tag=new WebAssembly.Tag({parameters:["i32"]});return(new Map).set(r.debug_tag,0),r.wasm=await WebAssembly.instantiate(t,{env:{...z.makeEnv(r,s,i),...z.env},wasi_snapshot_preview1:z.makeEnv(r,n,e)}),r.memory=r.wasm.exports.memory,r.calls=z.wrap_calls(r),r}async attach(t,e){if("string"==typeof t)switch(t){case"stdout":t=1;break;case"stderr":t=2;break;default:t=3}return void 0===this.fd[t]&&(this.fd[t]=[]),this.fd[t].push(e),this}async setCanvas(t){return this.canvas_id=t||void 0,this}handleWheel(t){this.wasm&&this.calls._lu5_mouse_scroll_callback(null,t.deltaX>0?1:-1,t.deltaY>0?1:-1)}handleKeydown(t){this.wasm&&this.calls._lu5_key_callback(null,D[t.keyCode]||0,t.key,t.repeat?2:1,q(t))}handleKeyup(t){this.wasm&&this.calls._lu5_key_callback(null,D[t.keyCode]||0,t.key,0,q(t))}handleMousemove(t){if(!this.wasm)return;const e=this.ctx.canvas.getBoundingClientRect();this.mouseX=Math.round(t.clientX-e.left),this.mouseY=Math.round(t.clientY-e.top),this.calls._lu5_mouse_cursor_callback(null,this.mouseX,this.mouseY)}handleMousedown(t){this.wasm&&this.calls._lu5_mouse_button_callback(null,t.button,1,0)}handleMouseup(t){this.wasm&&this.calls._lu5_mouse_button_callback(null,t.button,0,0)}execute(t){return new Promise((e=>{Y(this,N,"m",X).call(this,t,(()=>e(this)))}))}async reset(){return this.loop=!1,await new Promise((t=>setTimeout((()=>{this.wasm?(this.l5&&this.calls._lu5_close(this.l5),this.ctx&&!this.canvas_id?this.ctx.canvas.remove():this.ctx&&(this.ctx.canvas.style.display="none"),this.fd=[],delete this.wasm,t(void 0)):t(void 0)})))),this}}async function G(t){let e=t.getAttribute("src");return e?fetch(e).then((t=>t.text())):t.textContent}function V(t){return t.hasAttribute("canvas")?t.getAttribute("canvas"):t.hasAttribute("src")?t.getAttribute("src").split("/").join("").split(".").filter((t=>0!=t.length)).pop():""}N=new WeakSet,X=function(t,e=()=>{}){if(!this.wasm)return void this.warn("lu5 wasm hasn't loaded yet.");this.l5||(Object.defineProperty(this,"l5",{writable:!1,value:this.calls._lu5_get_handle()}),this.calls._lu5_init(this.l5));const i=this.calls.malloc(t.length);if(c(this.memory,i,t),this.l5){if(0!==this.calls._lu5_setup(this.l5,null,i))return this.calls.free(i),void e();{const t=this.view.getInt32(this.l5+8,!0);let e=0,i=1e3/t,s=window.performance.now();this.frame=function(n){this.loop&&(requestAnimationFrame(this.frame),e=n-s,(-1==t||e>=i)&&(s=n,this.calls._lu5_animation_frame(this.l5,e)))}.bind(this),requestAnimationFrame(this.frame)}}else this.calls.free(i)},z.err_prefix="[30;41m ERROR [0m",z.env={getTempRet0:()=>0,saveSetjmp:()=>0,testSetjmp:()=>0},Object.defineProperty(window,"_lu5_instantiate_script",{value:document.currentScript,writable:!1});const J="https://unpkg.com/lu5-wasm@latest/dist/lu5.wasm";window._get_or_create_by_id=O,document.currentScript.hasAttribute("lib")?window.lu5={init:(t=J)=>z.compile(t).then((t=>z.instantiate(t))),compile:(t=J)=>z.compile(t),instantiate:t=>z.instantiate(t),Console:class{constructor(){return console.warn("`lu5-console` is required to use the DOM console emulator"),null}}}:window.onload=()=>{let t=J;window._lu5_instantiate_script.hasAttribute("wasm")&&(t=window._lu5_instantiate_script.getAttribute("wasm")),z.compile(t).then((t=>z.instantiate(t))).then((t=>t.attach(1,console))).then((t=>t.attach(2,console))).then((async t=>{const{id:e,source:i}=await async function(){const t=document.querySelectorAll('script[type="text/lua"]')[0];return null==t?(console.warn("No lua scripts found..."),{id:"",source:""}):{id:V(t),source:await G(t)}}();return t.setCanvas(e).then((t=>t.execute(i)))})).catch(console.error)}})();