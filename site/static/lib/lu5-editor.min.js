import*as e from"https://matiasvlevi.github.io/lu5/assets/codemirror.min.js";import*as t from"https://unpkg.com/lu5-components@latest/dist/lu5-console.min.js";import*as n from"https://unpkg.com/lu5-wasm@latest/dist/lu5-wasm-lib.min.js";var o={43:function(e,t,n){var o=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n);var s=Object.getOwnPropertyDescriptor(t,n);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,o,s)}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&o(t,e,n);return s(t,e),t},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const c=r(n(567)),l=i(n(196)),a=n(214);let d=new a.Compartment;function u(){const e=localStorage.getItem("sketches");return e?JSON.parse(e):{}}let h=(new Date).getTime();function p(e,t){const n=u(),o=(new Date).getTime();o>h+1e3&&(n[e]={source:t,date:o,name:e},localStorage.setItem("sketches",JSON.stringify(n)),h=o)}function f(e){const t=u();delete t[e],localStorage.setItem("sketches",JSON.stringify(t))}const m=["open-sketch","save-sketch","generic"];class v{vm;module;editor;console;id;selected;constructor(e="lu5-editor"){this.id=e,this.vm=null,this.module=null,this.editor=null,this.console=null}async init(){const e=document.getElementById(this.id);return this.module=await l.compile(),this.editor=new a.EditorView({doc:"function setup()\n  createWindow(400, 400);\nend\n\nfunction draw()\n  background('purple');\nend",extensions:[(0,a.lineNumbers)(),(0,a.highlightSpecialChars)(),(0,a.history)(),(0,a.drawSelection)(),a.EditorState.allowMultipleSelections.of(!0),(0,a.indentOnInput)(),(0,a.syntaxHighlighting)(a.defaultHighlightStyle,{fallback:!0}),a.keymap.of([...a.defaultKeymap,...a.historyKeymap,a.indentWithTab]),d.of(a.EditorState.tabSize.of(2))],parent:e}),this.console=new c.default("lu5-console",{hide_if_can:!1,resize:"vertical"}),Array.from(document.querySelectorAll('button[value="cancel"]')).forEach((e=>{e.addEventListener("click",(t=>{e.parentElement instanceof HTMLDialogElement&&e.parentElement.close(),e.parentElement.parentElement instanceof HTMLDialogElement&&e.parentElement.parentElement.close(),e.parentElement.parentElement.parentElement instanceof HTMLDialogElement&&e.parentElement.parentElement.parentElement.close()}))})),this}static urlSafeRandomBase64String(){const e=new Uint8Array(6);window.crypto.getRandomValues(e);return btoa(String.fromCharCode(...e)).replace(/\+/g,"a").replace(/\//g,"b").replace(/=/g,"c").substring(0,8)}save(){this.selected?(p(this.selected,this.editor.state.doc.toString()),this.openGenericPopup("Success",`Saved as ${this.selected}`)):this.saveAs()}saveAs(){const e=document.querySelector(`dialog.popup.${m[1]}`);e.addEventListener("close",(()=>this.refresh(1))),e.showModal(),e.querySelector('button.formbtn[value="default"]').style["z-index"]=0,e.querySelector('button.formbtn[value="default"]').addEventListener("click",(t=>{const n=document.querySelector("input.sketch-name"),o=0===n.value.length?`sketch-${v.urlSafeRandomBase64String()}`:n.value;this.selected=o,p(this.selected,this.editor.state.doc.toString()),this.refresh(1),e.close(),this.openGenericPopup("Success",`Saved as ${o}`)}))}open(e=!0){const t=document.querySelector(`dialog.popup.${m[0]}`),n=u(),o=document.querySelector("div.sketch-selector");if(0===Object.keys(n).length)return t.close(),void this.openGenericPopup("Select Sketch","No saved sketches...");for(const e in n){const t=n[e],s=document.createElement("div");s.classList.add("saved-sketch","flex","gap-4"),s.classList.contains("selected")&&s.classList.remove("selected"),this.selected&&e==this.selected&&s.classList.add("selected");const i=document.createElement("span");i.classList.add("text","bold"),i.textContent=e;const r=document.createElement("span");r.classList.add("text","grey");const c=new Date(t.date);r.textContent=`${c.toDateString()} at ${c.toTimeString().split(" ")[0]}`;const l=document.createElement("div");l.classList.add("flex-col","gap-2"),l.appendChild(i),l.appendChild(r);const a=t=>{s.addEventListener("click",a),this.selected!==e&&(this.selected=e,this.refresh(0),this.open(!1))};s.addEventListener("click",a);const d=document.createElement("button");d.textContent="X",d.style.cssText="\n                padding: 0.45rem;\n                color: var(--white);\n                background-color: var(--primary);\n                z-index: 5;\n            ";const u=t=>{t.stopImmediatePropagation(),d.removeEventListener("click",u),e==this.selected&&(this.selected=void 0),f(e),this.refresh(0),this.open(!1)};d.addEventListener("click",u),s.appendChild(l),s.appendChild(d),o.appendChild(s)}e&&(t.showModal(),t.querySelector('button.formbtn[value="default"]').addEventListener("click",(e=>{if(!this.selected)return;const n=u(),{source:o}=n[this.selected];this.editor.dispatch({changes:{from:0,to:this.editor.state.doc.length,insert:o}}),this.refresh(0),t.close()})),t.addEventListener("close",(()=>{this.refresh(0)})))}openSketch(){if(!this.selected)return;const e=u(),{source:t}=e[this.selected];this.editor.dispatch({changes:{from:0,to:this.editor.state.doc.length,insert:t}}),this.refresh(0);document.querySelector(`dialog.popup.${m[0]}`).close()}setGenericPopup(e,t){const n=document.querySelector("dialog.popup.generic > div > p"),o=document.querySelector("dialog.popup.generic > div > div > span");n.textContent=e,o.textContent=t}openGenericPopup(e,t){this.setGenericPopup(e,t);const n=document.querySelector(`dialog.popup.${m[2]}`);return n.showModal(),n}refresh(e){if(m[e])switch(e){case 0:document.querySelector("div.sketch-selector").innerHTML="";break;case 1:document.querySelector("input.sketch-name").value="";break}}closeDialog(e){this.refresh(e);document.querySelector("dialog.popup"+(e?`.${e}`:"")).close()}async run(){if(!this.editor||!this.module||!this.console)return;const e=this.editor.state.doc.toString();return this.vm&&await this.stop(),this.vm=await l.instantiate(this.module).then((e=>e.setCanvas("lu5-sketch"))).then((e=>e.attach(1,this.console))).then((e=>e.attach(2,this.console))),this.vm?await this.vm.execute(e):void 0}async stop(){if(this.vm)return this.vm.loop=!1,await this.vm.clear().reset(),this.vm=null,this}}t.default=v},156:function(e,t,n){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=o(n(43)),i=n(839);window.onload=()=>{window.editor=new s.default,window.editor.init(),window.run=function(){window.editor.run()},window.stop=function(){window.editor.stop()},(0,i.init_panes)()}},839:(e,t)=>{function n(e,t){let n;const o=e.previousSibling,s=e.nextSibling;function i(i){var r={x:i.clientX-n.e.clientX,y:i.clientY-n.e.clientY};if("H"===t){r.x=Math.min(Math.max(r.x,-n.firstWidth),n.secondWidth),e.style.left=n.offsetLeft+r.x+"px";if(n.firstWidth+r.x<320)return;o.style.width=n.firstWidth+r.x+"px",s.style.width=n.secondWidth-r.x+"px"}else if("V"===t){r.y=Math.min(Math.max(r.y,-n.firstWidth),n.secondWidth);const t=n.secondWidth-r.y;if(t<72)return;e.style.top=n.offsetTop+r.y+"px";const i=n.firstWidth+r.y;o.style.height=i+"px",s.style.height=t+"px"}}e.onmousedown=function(r){n="H"===t?{e:r,offsetLeft:e.offsetLeft,offsetTop:e.offsetTop,firstWidth:o.offsetWidth,secondWidth:s.offsetWidth}:{e:r,offsetLeft:e.offsetLeft,offsetTop:e.offsetTop,firstWidth:o.offsetHeight,secondWidth:s.offsetHeight};document.onmousemove=i,document.onmouseup=()=>{document.onmousemove=document.onmouseup=null}}}Object.defineProperty(t,"__esModule",{value:!0}),t.dragElement=n,t.init_panes=function(){n(document.querySelector(".horizontal.separator"),"H"),n(document.querySelector(".vertical.separator"),"V")}},214:t=>{t.exports=e},567:e=>{e.exports=t},196:e=>{e.exports=n}},s={};(function e(t){var n=s[t];if(void 0!==n)return n.exports;var i=s[t]={exports:{}};return o[t].call(i.exports,i,i.exports,e),i.exports})(156);